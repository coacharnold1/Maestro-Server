<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Tweaks - Maestro Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { font-size: 2em; color: #3498db; }
        .back-btn {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid #3498db;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .back-btn:hover { background: #3498db; color: white; }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .section-title { font-size: 1.5em; margin-bottom: 20px; color: #27ae60; }
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #95a5a6;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #ecf0f1;
            font-size: 1em;
        }
        .btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        .device-list {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            color: #2ecc71;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .message.success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
            color: #27ae60;
        }
        .message.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        .message.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéõÔ∏è Audio Tweaks</h1>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
                <a href="javascript:window.location.href='http://' + window.location.hostname + ':5003'" class="back-btn" style="background: rgba(52, 152, 219, 0.2); border-color: #3498db; color: #3498db;">üéµ Maestro Control</a>
            </div>
        </header>
        
        <div id="message" class="message"></div>
        
        <div class="section">
            <h2 class="section-title">Audio Devices</h2>
            <button class="btn" onclick="loadAudioDevices()">üîç Scan Audio Devices</button>
            <div id="device-list" class="device-list" style="margin-top: 20px;">Click "Scan Audio Devices" to detect available audio hardware</div>
        </div>
        
        <div class="section">
            <h2 class="section-title">MPD Audio Configuration</h2>
            <div id="current-device-info" style="background: #34495e; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                <strong>Current Device:</strong> <span id="current-device-display" style="color: #3498db;">Loading...</span>
            </div>
            <form id="audio-config-form" onsubmit="saveAudioConfig(event)">
                <div class="form-group">
                    <label>Audio Output Device</label>
                    <select id="audio-device">
                        <option value="default">Default ALSA Device</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Select which audio device MPD should use</small>
                </div>
                
                <div class="form-group">
                    <label>Buffer Size</label>
                    <select id="buffer-size">
                        <option value="2048">2048 (Low Latency)</option>
                        <option value="4096" selected>4096 (Balanced)</option>
                        <option value="8192">8192 (High Quality)</option>
                        <option value="16384">16384 (Maximum Quality)</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Larger buffers = better quality, higher latency</small>
                </div>
                
                <div class="form-group">
                    <label>Output Format</label>
                    <select id="output-format">
                        <option value="native" selected>Native (Let DAC Handle)</option>
                        <option value="44100:16:2">44.1kHz 16-bit Stereo</option>
                        <option value="48000:24:2">48kHz 24-bit Stereo</option>
                        <option value="96000:24:2">96kHz 24-bit Stereo</option>
                        <option value="192000:24:2">192kHz 24-bit Stereo</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Native = bit-perfect playback</small>
                </div>
                
                <div class="form-group">
                    <label>Resample Quality (if needed)</label>
                    <select id="resample-quality">
                        <option value="disabled" selected>Disabled (Bit-Perfect)</option>
                        <option value="very_high">Very High (SRC)</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Leave disabled for audiophile playback</small>
                </div>
                
                <div class="form-group">
                    <label>Mixer Type</label>
                    <select id="mixer-type">
                        <option value="none" selected>None (Pure Digital)</option>
                        <option value="software">Software</option>
                        <option value="hardware">Hardware</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">None = use DAC volume control</small>
                </div>
                
                <div class="form-group">
                    <label>DSD Playback</label>
                    <select id="dsd-mode">
                        <option value="auto" selected>Auto (Native if supported)</option>
                        <option value="dop">DoP (DSD over PCM)</option>
                        <option value="pcm">Convert to PCM</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Auto recommended for modern DACs</small>
                </div>
                
                <button type="submit" class="btn">üíæ Save MPD Configuration</button>
            </form>
        </div>
        
        <div class="section">
            <h2 class="section-title">üåê HTTP Streaming (Multi-Room Playback)</h2>
            <p style="color: #95a5a6; margin-bottom: 20px;">Enable HTTP streaming for multi-room playback using Raspberry Pi clients or mpv</p>
            
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                    <input type="checkbox" id="streaming-enabled" onchange="toggleStreaming()" style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="font-size: 1.1em; font-weight: 600;">Enable HTTP Streaming</span>
                </label>
                <div id="stream-url-display" style="flex: 1; text-align: right; font-family: monospace; color: #3498db; display: none;"></div>
            </div>
            
            <div id="streaming-advanced" style="display: none; margin-top: 20px;">
                <h3 style="color: #3498db; margin-bottom: 15px; font-size: 1.2em;">Advanced Settings</h3>
                
                <div class="form-group">
                    <label>Stream Name</label>
                    <input type="text" id="stream-name" value="HTTP Stream" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Name that appears to clients</small>
                </div>
                
                <div class="form-group">
                    <label>Port</label>
                    <input type="number" id="stream-port" value="8000" min="1024" max="65535" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">TCP port for streaming (default: 8000)</small>
                </div>
                
                <div class="form-group">
                    <label>Encoder</label>
                    <select id="stream-encoder" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                        <option value="">None (Lossless WAVE - High Bandwidth)</option>
                        <option value="lame">MP3 (LAME) - Good Quality, Compatible</option>
                        <option value="vorbis">Ogg Vorbis - Better Quality</option>
                        <option value="opus">Opus - Best Quality/Size Ratio</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">‚ö†Ô∏è No encoder = lossless but uses ~1.5 Mbps bandwidth</small>
                </div>
                
                <div class="form-group">
                    <label>Bitrate (kbps)</label>
                    <select id="stream-bitrate" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                        <option value="">Default (codec dependent)</option>
                        <option value="128">128 kbps</option>
                        <option value="192">192 kbps</option>
                        <option value="256">256 kbps</option>
                        <option value="320">320 kbps</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">Only used when encoder is selected</small>
                </div>
                
                <div class="form-group">
                    <label>Format</label>
                    <input type="text" id="stream-format" placeholder="44100:16:2 or leave empty for MPD default" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">samplerate:bits:channels (empty = use audio file's format)</small>
                </div>
                
                <div class="form-group">
                    <label>Max Clients</label>
                    <input type="number" id="stream-max-clients" value="0" min="0" max="100" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">0 = unlimited</small>
                </div>
                
                <div class="form-group">
                    <label>Bind Address</label>
                    <input type="text" id="stream-bind-address" value="0.0.0.0" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ecf0f1;">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">0.0.0.0 = listen on all interfaces</small>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveStreamingConfig()">üíæ Save Streaming Config</button>
                <button class="btn" onclick="toggleAdvancedStreaming()" style="background: rgba(52, 152, 219, 0.2); border: 1px solid #3498db; color: #3498db;">‚öôÔ∏è Advanced</button>
            </div>
            
            <div id="streaming-info" style="margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-left: 4px solid #3498db; border-radius: 4px; display: none;">
                <strong style="color: #3498db;">üì± Client Setup</strong>
                <p style="margin: 10px 0; color: #ecf0f1;">To connect a Raspberry Pi or other device, use mpv:</p>
                <code style="display: block; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; color: #2ecc71; font-family: monospace;">
                    mpv --no-video --audio-device=alsa/hw:1,0 http://SERVER-IP:PORT
                </code>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #95a5a6;">See Ras-Pi-Client.md for detailed multi-room setup instructions</p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">System Audio Optimization</h2>
            <p style="color: #95a5a6; margin-bottom: 20px;">Optimize system settings for audiophile playback (requires restart)</p>
            
            <div class="form-group">
                <label>CPU Governor</label>
                <select id="cpu-governor">
                    <option value="performance">Performance (Best for Audio)</option>
                    <option value="ondemand" selected>On-Demand (Balanced)</option>
                    <option value="powersave">Power Save</option>
                </select>
                <small style="color: #7f8c8d; margin-top: 5px; display: block;">Performance mode reduces jitter</small>
            </div>
            
            <div class="form-group">
                <label>MPD Process Priority</label>
                <select id="mpd-priority">
                    <option value="realtime">Real-Time (Highest)</option>
                    <option value="high" selected>High</option>
                    <option value="normal">Normal</option>
                </select>
                <small style="color: #7f8c8d; margin-top: 5px; display: block;">Real-time prevents audio dropouts</small>
            </div>
            
            <div class="form-group">
                <label>System Swappiness (Lower = Less Disk IO)</label>
                <select id="swappiness">
                    <option value="10" selected>10 (Audiophile)</option>
                    <option value="30">30 (Balanced)</option>
                    <option value="60">60 (Default)</option>
                </select>
                <small style="color: #7f8c8d; margin-top: 5px; display: block;">Lower values keep audio in RAM</small>
            </div>
            
            <button class="btn" onclick="applySystemTweaks()">‚ö° Apply System Tweaks</button>
        </div>
    </div>
    
    <script>
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type} active`;
            setTimeout(() => msg.classList.remove('active'), 5000);
        }
        
        function loadAudioDevices() {
            showMessage('Scanning audio devices...', 'success');
            fetch('/api/audio/devices')
                .then(response => response.json())
                .then(data => {
                    const deviceList = document.getElementById('device-list');
                    const deviceSelect = document.getElementById('audio-device');
                    
                    if (data.status === 'success') {
                        if (data.devices && data.devices.length > 0) {
                            // Format device list nicely
                            const formattedDevices = data.devices.map(dev => `<div style="padding: 10px; background: rgba(39, 174, 96, 0.1); border-left: 3px solid #27ae60; margin: 5px 0; border-radius: 5px;">üéµ ${dev}</div>`).join('');
                            deviceList.innerHTML = `<div style="margin-bottom: 10px;"><strong>${data.device_count} audio device(s) found:</strong></div>${formattedDevices}`;
                            
                            // Populate device selector dropdown
                            deviceSelect.innerHTML = '<option value="default">Default ALSA Device</option>';
                            data.parsed_devices.forEach(dev => {
                                const option = document.createElement('option');
                                option.value = dev.hw_string;
                                option.textContent = `${dev.name} (${dev.hw_string})`;
                                deviceSelect.appendChild(option);
                            });
                            
                            // Load and display current device
                            fetch('/api/audio/config')
                                .then(r => r.json())
                                .then(configData => {
                                    if (configData.status === 'success' && configData.config.current_device) {
                                        const currentDev = configData.config.current_device;
                                        document.getElementById('current-device-display').textContent = currentDev;
                                        // Select current device in dropdown
                                        deviceSelect.value = currentDev;
                                    }
                                });
                            
                            showMessage(`‚úÖ Found ${data.device_count} audio device(s)`, 'success');
                        } else {
                            deviceList.innerHTML = '<div style="padding: 20px; color: #e74c3c; text-align: center;">‚ö†Ô∏è No audio devices found. Make sure audio hardware is connected.</div>';
                            showMessage('No audio devices detected', 'error');
                        }
                    } else {
                        deviceList.innerHTML = `<div style="padding: 20px; color: #e74c3c;">Error: ${data.message}</div>`;
                        showMessage('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    document.getElementById('device-list').innerHTML = `<div style="padding: 20px; color: #e74c3c;">Network error: ${error.message}</div>`;
                    showMessage('Network error: ' + error.message, 'error');
                });
        }
        
        function applySystemTweaks() {
            const config = {
                cpu_governor: document.getElementById('cpu-governor').value,
                mpd_priority: document.getElementById('mpd-priority').value,
                swappiness: parseInt(document.getElementById('swappiness').value)
            };
            
            showMessage('Applying system tweaks...', 'success');
            
            fetch('/api/audio/system-tweaks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('System tweaks applied! Restart may be required.', 'success');
                } else {
                    showMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showMessage('Network error: ' + error.message, 'error'));
        }
        
        function saveAudioConfig(event) {
            event.preventDefault();
            
            const config = {
                audio_device: document.getElementById('audio-device').value,
                buffer_size: parseInt(document.getElementById('buffer-size').value),
                output_format: document.getElementById('output-format').value,
                resample_quality: document.getElementById('resample-quality').value,
                mixer_type: document.getElementById('mixer-type').value,
                dsd_mode: document.getElementById('dsd-mode').value
            };
            
            fetch('/api/audio/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show detailed verification
                    const configStr = JSON.stringify(data.saved_config, null, 2);
                    showMessage(`‚úÖ Configuration saved!\n\nAudio Device: ${data.saved_config.audio_device}\nBuffer: ${data.saved_config.buffer_size}\nFormat: ${data.saved_config.output_format}\nResample: ${data.saved_config.resample_quality}\nMixer: ${data.saved_config.mixer_type}\nDSD: ${data.saved_config.dsd_mode}\n\n${data.mpd_updated ? '‚úÖ MPD config updated' : '‚ö†Ô∏è MPD config update failed'}\n\n‚ö†Ô∏è Restart MPD to apply changes`, 'success');
                } else {
                    showMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showMessage('Network error: ' + error.message, 'error'));
        }
        
        // Load current config on page load
        fetch('/api/audio/config')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const config = data.config;
                    if (config.buffer_size) document.getElementById('buffer-size').value = config.buffer_size;
                    if (config.output_format) document.getElementById('output-format').value = config.output_format;
                    if (config.resample_quality) document.getElementById('resample-quality').value = config.resample_quality;
                    if (config.mixer_type) document.getElementById('mixer-type').value = config.mixer_type;
                    if (config.dsd_mode) document.getElementById('dsd-mode').value = config.dsd_mode;
                }
            });

        // HTTP Streaming functions
        function toggleAdvancedStreaming() {
            const advanced = document.getElementById('streaming-advanced');
            const toggle = event.currentTarget;
            if (advanced.style.display === 'none') {
                advanced.style.display = 'block';
                toggle.textContent = 'Hide Advanced Settings';
            } else {
                advanced.style.display = 'none';
                toggle.textContent = 'Show Advanced Settings';
            }
        }

        function loadStreamingConfig() {
            fetch('/api/streaming/config')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const config = data.config;
                        document.getElementById('streaming-enabled').checked = config.enabled;
                        document.getElementById('streaming-name').value = config.name || 'Maestro HTTP Stream';
                        document.getElementById('streaming-port').value = config.port || '8000';
                        document.getElementById('streaming-encoder').value = config.encoder || 'lame';
                        document.getElementById('streaming-bitrate').value = config.bitrate || '192';
                        document.getElementById('streaming-format').value = config.format || '44100:16:2';
                        document.getElementById('streaming-max-clients').value = config.max_clients || '0';
                        document.getElementById('streaming-bind').value = config.bind_to_address || '0.0.0.0';
                        
                        // Update stream URL display
                        const hostname = window.location.hostname;
                        const port = config.port || '8000';
                        document.getElementById('stream-url').textContent = `http://${hostname}:${port}/`;
                        document.getElementById('stream-url-display').style.display = config.enabled ? 'block' : 'none';
                    }
                })
                .catch(error => showMessage('Failed to load streaming config: ' + error.message, 'error'));
        }

        function toggleStreaming() {
            const enabled = document.getElementById('streaming-enabled').checked;
            const config = {
                enabled: enabled,
                name: document.getElementById('streaming-name').value,
                port: document.getElementById('streaming-port').value,
                encoder: document.getElementById('streaming-encoder').value,
                bitrate: document.getElementById('streaming-bitrate').value,
                format: document.getElementById('streaming-format').value,
                max_clients: document.getElementById('streaming-max-clients').value,
                bind_to_address: document.getElementById('streaming-bind').value
            };

            fetch('/api/streaming/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(`‚úÖ HTTP streaming ${enabled ? 'enabled' : 'disabled'}!\n\n${data.message}`, 'success');
                    loadStreamingConfig();
                } else {
                    showMessage('Error: ' + data.message, 'error');
                    document.getElementById('streaming-enabled').checked = !enabled;
                }
            })
            .catch(error => {
                showMessage('Network error: ' + error.message, 'error');
                document.getElementById('streaming-enabled').checked = !enabled;
            });
        }

        function saveStreamingConfig() {
            const enabled = document.getElementById('streaming-enabled').checked;
            const config = {
                enabled: enabled,
                name: document.getElementById('streaming-name').value,
                port: document.getElementById('streaming-port').value,
                encoder: document.getElementById('streaming-encoder').value,
                bitrate: document.getElementById('streaming-bitrate').value,
                format: document.getElementById('streaming-format').value,
                max_clients: document.getElementById('streaming-max-clients').value,
                bind_to_address: document.getElementById('streaming-bind').value
            };

            fetch('/api/streaming/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(`‚úÖ HTTP streaming configuration saved!\n\n${data.message}`, 'success');
                    loadStreamingConfig();
                } else {
                    showMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showMessage('Network error: ' + error.message, 'error'));
        }

        // Load streaming config on page load
        loadStreamingConfig();
    </script>
</body>
</html>
