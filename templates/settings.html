{% extends 'base_layout.html' %}
{% block title %}Settings ¬∑ Maestro-MPD{% endblock %}
{% block content %}
<div style="text-align:center; margin-bottom: 10px;">
    <img src="https://raw.githubusercontent.com/github/explore/main/topics/music/music.png" alt="Maestro" style="height:40px; opacity:0.85;"/>
    <h1 style="margin:6px 0 0; font-size:1.2em;">Settings</h1>
</div>

<div class="status-box" id="squeezebox-section" style="display:none;">
    <h2 style="text-align:left;">Squeezebox Players</h2>
    <div class="controls" style="border-top:none;">
        <div style="margin-bottom:12px; padding:8px; background:rgba(52,152,219,0.1); border-radius:6px; font-size:0.9em; color:#bdc3c7;">
            <strong>‚ÑπÔ∏è Multi-Room Audio:</strong> Stream Maestro's audio to Squeezebox devices around your home via Logitech Media Server.
            Configure LMS settings in the <a href="javascript:window.location.href='http://' + window.location.hostname + ':5004/system'" style="color:#3498db;">Admin Panel ‚Üí System</a>.
        </div>
        <div id="lms-not-configured" style="display:none; padding:12px; background:rgba(243,156,18,0.2); border-left:4px solid #f39c12; border-radius:4px; margin-bottom:12px;">
            <strong style="color:#f39c12;">‚ö†Ô∏è LMS Not Configured</strong>
            <div style="color:#ecf0f1; margin-top:5px; font-size:0.9em;">
                Enable and configure Logitech Media Server in the <a href="javascript:window.location.href='http://' + window.location.hostname + ':5004/system'" style="color:#3498db;">Admin Panel</a>.
            </div>
        </div>
        <div id="player-list" style="margin-top:10px;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px;">
            <button type="button" class="button" onclick="refreshPlayers()" style="background:#3498db; color:#ecf0f1;">üîÑ Refresh Players</button>
            <button type="button" class="button" onclick="syncSelectedPlayers()" style="background:#2ecc71; color:#1a1a1a;">‚ñ∂Ô∏è Start Streaming</button>
            <button type="button" class="button" onclick="unsyncSelectedPlayers()" style="background:#e74c3c; color:#ecf0f1;">‚èπÔ∏è Stop Streaming</button>
        </div>
        <div id="lms-status-message" style="margin-top:12px; padding:10px; border-radius:6px; display:none;"></div>
    </div>
</div>

<div class="status-box">
    <form method="POST" action="/settings" style="margin:0;">
        <h2 style="text-align:left;">Theme</h2>
        <div class="controls" style="border-top:none;">
            <label for="theme" style="margin-right:8px;">Select Theme:</label>
            <select id="theme" name="theme" style="padding:6px 10px; border-radius:6px;">
                <option value="dark" {% if theme == 'dark' %}selected{% endif %}>Dark (default)</option>
                <option value="light" {% if theme == 'light' %}selected{% endif %}>Light</option>
                <option value="high-contrast" {% if theme == 'high-contrast' %}selected{% endif %}>High Contrast</option>
                <option value="desert" {% if theme == 'desert' %}selected{% endif %}>Desert</option>
                <option value="terminal" {% if theme == 'terminal' %}selected{% endif %}>Terminal (Retro)</option>
                <option value="sunset" {% if theme == 'sunset' %}selected{% endif %}>Sunset</option>
                <option value="forest" {% if theme == 'forest' %}selected{% endif %}>Forest</option>
                <option value="midnight" {% if theme == 'midnight' %}selected{% endif %}>Midnight</option>
            </select>
        </div>

        <h2 style="text-align:left; margin-top:14px;">Player Settings</h2>
        <div class="controls" style="border-top:none;">
            <div style="margin:6px 0; text-align:left;">
                <label>
                    <input type="checkbox" name="hide_volume_controls" id="hide_volume_controls" {% if hide_volume_controls %}checked{% endif %}>
                    Hide volume controls on main page
                </label>
                <div style="margin-top:4px; color:#bdc3c7; font-size:0.9em;">
                    Enable this if you use a fixed DAC volume or have hardware volume control
                </div>
            </div>
        </div>

        <h2 style="text-align:left; margin-top:14px;">Last.fm</h2>
        <div class="controls" style="border-top:none;">
            <div style="margin:6px 0; text-align:left;">
                <label>
                    <input type="checkbox" name="enable_scrobbling" id="enable_scrobbling" {% if enable_scrobbling %}checked{% endif %}>
                    Enable scrobbling (submit plays to Last.fm)
                </label>
                <div style="margin-top:4px; color:#bdc3c7; font-size:0.9em;">
                    Status: <strong id="scrobble-status">{{ 'Connected' if lastfm_connected else 'Not connected' }}</strong>
                </div>
            </div>
            <div style="margin:6px 0; text-align:left;">
                <label>
                    <input type="checkbox" name="show_scrobble_toasts" id="show_scrobble_toasts" {% if show_scrobble_toasts %}checked{% endif %}>
                    Show on-screen toasts for Last.fm events
                </label>
                <div style="margin-top:4px; color:#95a5a6; font-size:0.85em;">
                    Info toast when Now Playing is sent; success toast when a track is scrobbled.
                </div>
            </div>
            <div style="margin:6px 0;">
                <label for="lastfm_api_key" style="display:inline-block; min-width:140px; text-align:right; margin-right:6px;">API Key:</label>
                <input type="text" id="lastfm_api_key" name="lastfm_api_key" placeholder="Enter new API key" value="{{ lastfm_api_key_masked }}" style="padding:6px 10px; border-radius:6px; width:60%;"/>
                <small style="color:#bdc3c7; margin-left:6px;">Leave empty to keep current</small>
            </div>
            <div style="margin:6px 0;">
                <label for="lastfm_shared_secret" style="display:inline-block; min-width:140px; text-align:right; margin-right:6px;">Shared Secret:</label>
                <input type="password" id="lastfm_shared_secret" name="lastfm_shared_secret" placeholder="Enter new shared secret" value="{{ lastfm_shared_secret_masked }}" style="padding:6px 10px; border-radius:6px; width:60%;"/>
                <small style="color:#bdc3c7; margin-left:6px;">Leave empty to keep current</small>
            </div>
            <div style="margin:10px 0; padding:8px; background:rgba(52,152,219,0.1); border-radius:6px; font-size:0.9em; color:#bdc3c7;">
                <strong>Setup Steps:</strong> 1) Enter credentials above ‚Üí 2) Click "Test Last.fm" (optional) ‚Üí 3) Click "Save Settings" ‚Üí 4) Click "Connect to Last.fm" ‚Üí 5) Authorize on Last.fm website ‚Üí 6) Click "Finalize Connection"
            </div>
            <div style="margin:10px 0; display:flex; justify-content:center; flex-wrap:wrap; gap:6px;">
                <button type="button" class="button" id="btn-test-lastfm" style="background:#3498db; color:#ecf0f1;">Test Last.fm</button>
                <button type="button" class="button" id="btn-connect-lastfm" style="background:#9b59b6; color:#ecf0f1;">‚ë† Connect to Last.fm</button>
                <button type="button" class="button" id="btn-finalize-lastfm" style="background:#8e44ad; color:#ecf0f1;">‚ë° Finalize Connection</button>
                <span id="lastfm-test-result" style="margin-left:8px; font-weight:bold;"></span>
            </div>
        </div>

        <div style="border-top: 2px solid #34495e; margin-top: 20px; padding-top: 20px;">
            <div class="controls" style="border-top:none;">
                <button type="submit" class="button" style="background:#2ecc71; color:#1a1a1a; padding: 12px 30px; font-size: 1.05em; font-weight: bold;">üíæ Save All Settings</button>
            </div>
        </div>
    </form>
</div>

    <div class="status-box">
        <form method="POST" action="/settings/genius" style="margin:0;">
            <h2 style="text-align:left;">üéµ Genius API (Lyrics)</h2>
            <div class="controls" style="border-top:none;">
                <div style="margin:10px 0; padding:10px; background:rgba(155,89,182,0.15); border-left:3px solid #9b59b6; border-radius:4px; font-size:0.85em; color:#ecf0f1;">
                    <strong>üìñ Setup Steps:</strong>
                    <ol style="margin:8px 0 0 20px;">
                        <li>Go to <a href="https://genius.com/api-clients" target="_blank" style="color:#3498db;">genius.com/api-clients</a></li>
                        <li>Sign in (create free account if needed)</li>
                        <li>Click "New API Client"</li>
                        <li>Copy your <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                        <li>Paste below and click "Save"</li>
                    </ol>
                </div>
                <div style="margin:15px 0;">
                    <label for="genius_client_id" style="display:block; font-weight:bold; margin-bottom:5px;">Client ID:</label>
                    <input type="text" id="genius_client_id" name="genius_client_id" placeholder="Paste Client ID" value="{{ genius_client_id or '' }}" style="padding:8px; width:100%; border-radius:6px; box-sizing:border-box; font-family:monospace;"/>
                </div>
                <div style="margin:15px 0;">
                    <label for="genius_client_secret" style="display:block; font-weight:bold; margin-bottom:5px;">Client Secret:</label>
                    <input type="password" id="genius_client_secret" name="genius_client_secret" placeholder="Paste Client Secret" value="{{ genius_client_secret or '' }}" style="padding:8px; width:100%; border-radius:6px; box-sizing:border-box; font-family:monospace;"/>
                </div>
                <div style="margin:15px 0;">
                    <label for="genius_access_token" style="display:block; font-weight:bold; margin-bottom:5px;">Access Token (optional):</label>
                    <input type="password" id="genius_access_token" name="genius_access_token" placeholder="Personal access token from Genius" value="{{ genius_access_token or '' }}" style="padding:8px; width:100%; border-radius:6px; box-sizing:border-box; font-family:monospace;"/>
                </div>
                <div style="margin:15px 0; display:flex; gap:8px;">
                    <button type="button" class="button" id="btn-test-genius" style="background:#3498db; color:#ecf0f1;">üß™ Test</button>
                    <button type="submit" class="button" style="background:#2ecc71; color:#1a1a1a;">üíæ Save</button>
                </div>
                <div id="genius-test-result" style="margin-top:12px; display:none; padding:10px; border-radius:6px;"></div>
            </div>
        </form>
    </div>

<script>
    // Last.fm functionality
    document.getElementById('btn-test-lastfm').addEventListener('click', async () => {
        const keyField = document.getElementById('lastfm_api_key');
        const testKey = keyField.value.trim();
        const form = new FormData();
        if (testKey) form.append('api_key', testKey);
        try {
            const resp = await fetch('/api/test_lastfm', { method: 'POST', body: form });
            const data = await resp.json();
            const el = document.getElementById('lastfm-test-result');
            el.textContent = data.message || 'Unknown response';
            el.style.color = data.status === 'success' ? '#2ecc71' : '#e74c3c';
        } catch (e) {
            const el = document.getElementById('lastfm-test-result');
            el.textContent = 'Request failed';
            el.style.color = '#e74c3c';
        }
    });
    
        // Genius API functionality
        if (document.getElementById('btn-test-genius')) {
            document.getElementById('btn-test-genius').addEventListener('click', async () => {
                const clientId = document.getElementById('genius_client_id').value.trim();
                const form = new FormData();
                if (clientId) form.append('genius_client_id', clientId);
                try {
                    const resp = await fetch('/api/test_genius', { method: 'POST', body: form });
                    const data = await resp.json();
                    const el = document.getElementById('genius-test-result');
                    el.textContent = data.message || 'Unknown response';
                    el.style.color = data.status === 'success' ? '#2ecc71' : '#e74c3c';
                    el.style.display = 'block';
                } catch (e) {
                    const el = document.getElementById('genius-test-result');
                    el.textContent = 'Network error: ' + e.message;
                    el.style.color = '#e74c3c';
                    el.style.display = 'block';
                }
            });
        }

    document.getElementById('btn-connect-lastfm').addEventListener('click', async () => {
        try {
            const resp = await fetch('/lastfm/request_token', { method: 'POST' });
            const data = await resp.json();
            if (data.status === 'success' && data.auth_url) {
                window.open(data.auth_url, '_blank');
            } else {
                alert(data.message || 'Failed to request token');
            }
        } catch (e) {
            alert('Failed to request token');
        }
    });

    document.getElementById('btn-finalize-lastfm').addEventListener('click', async () => {
        try {
            const resp = await fetch('/lastfm/finalize', { method: 'POST' });
            const data = await resp.json();
            if (data.status === 'success') {
                document.getElementById('scrobble-status').textContent = 'Connected';
                document.getElementById('scrobble-status').style.color = '#2ecc71';
                alert('Last.fm connected successfully.');
            } else {
                alert(data.message || 'Failed to finalize connection');
            }
        } catch (e) {
            alert('Finalize request failed');
        }
    });

    // Squeezebox/LMS functionality
    let currentPlayers = [];

    async function checkLMSStatus() {
        try {
            const resp = await fetch('/api/lms/status');
            const data = await resp.json();
            
            if (data.enabled && data.available) {
                document.getElementById('squeezebox-section').style.display = 'block';
                document.getElementById('lms-not-configured').style.display = 'none';
                refreshPlayers();
            } else if (data.enabled && !data.available) {
                document.getElementById('squeezebox-section').style.display = 'block';
                document.getElementById('lms-not-configured').style.display = 'block';
                document.getElementById('player-list').innerHTML = '<div style="color:#95a5a6; text-align:center; padding:20px;">Cannot connect to LMS server. Check configuration.</div>';
            } else {
                document.getElementById('squeezebox-section').style.display = 'none';
            }
        } catch (e) {
            console.error('Failed to check LMS status:', e);
        }
    }

    async function refreshPlayers() {
        try {
            const resp = await fetch('/api/lms/players');
            const data = await resp.json();
            
            if (data.status === 'success') {
                currentPlayers = data.players;
                renderPlayerList(data.players);
            } else {
                showLMSMessage(data.message || 'Failed to load players', 'error');
            }
        } catch (e) {
            showLMSMessage('Network error: ' + e.message, 'error');
        }
    }

    function renderPlayerList(players) {
        const container = document.getElementById('player-list');
        
        if (players.length === 0) {
            container.innerHTML = '<div style="color:#95a5a6; text-align:center; padding:20px;">No Squeezebox players found. Make sure your devices are powered on and connected to LMS.</div>';
            return;
        }
        
        let html = '<div style="display:grid; gap:10px;">';
        
        players.forEach(player => {
            const statusColor = player.connected ? '#2ecc71' : '#e74c3c';
            const statusText = player.connected ? 'Connected' : 'Offline';
            
            html += `
                <div style="background:rgba(255,255,255,0.05); border-radius:8px; padding:12px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <input type="checkbox" class="player-checkbox" data-player-id="${player.id}" 
                                   style="width:20px; height:20px; cursor:pointer;" ${player.connected ? '' : 'disabled'}>
                            <div>
                                <div style="font-weight:bold; color:#ecf0f1;">${player.name}</div>
                                <div style="font-size:0.85em; color:#95a5a6;">${player.model} ¬∑ ${player.ip || 'Unknown IP'}</div>
                            </div>
                        </div>
                        <div style="padding:4px 10px; border-radius:4px; background:rgba(${statusColor === '#2ecc71' ? '46,204,113' : '231,76,60'},0.2); border:1px solid ${statusColor}; color:${statusColor}; font-size:0.85em;">
                            ${statusText}
                        </div>
                    </div>
                    ${player.connected ? `
                    <div style="display:flex; align-items:center; gap:10px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#95a5a6; font-size:0.85em; min-width:50px;">üîä Volume</span>
                        <input type="range" min="0" max="100" value="50" 
                               class="volume-slider" data-player-id="${player.id}"
                               style="flex:1; height:6px; border-radius:3px; background:rgba(255,255,255,0.2); cursor:pointer;"
                               onchange="setPlayerVolume('${player.id}', this.value)">
                        <span class="volume-display" data-player-id="${player.id}" style="color:#ecf0f1; font-size:0.9em; min-width:40px; text-align:right;">50%</span>
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    async function syncSelectedPlayers() {
        const checkboxes = document.querySelectorAll('.player-checkbox:checked');
        const playerIds = Array.from(checkboxes).map(cb => cb.dataset.playerId);
        
        if (playerIds.length === 0) {
            showLMSMessage('Please select at least one player', 'warning');
            return;
        }
        
        try {
            const resp = await fetch('/api/lms/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ players: playerIds })
            });
            const data = await resp.json();
            
            if (data.status === 'success') {
                showLMSMessage('‚úÖ ' + data.message, 'success');
            } else {
                showLMSMessage('‚ùå ' + data.message, 'error');
            }
        } catch (e) {
            showLMSMessage('‚ùå Network error: ' + e.message, 'error');
        }
    }

    async function unsyncSelectedPlayers() {
        const checkboxes = document.querySelectorAll('.player-checkbox:checked');
        const playerIds = Array.from(checkboxes).map(cb => cb.dataset.playerId);
        
        if (playerIds.length === 0) {
            showLMSMessage('Please select at least one player', 'warning');
            return;
        }
        
        try {
            const resp = await fetch('/api/lms/unsync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ players: playerIds })
            });
            const data = await resp.json();
            
            if (data.status === 'success') {
                showLMSMessage('‚úÖ ' + data.message, 'success');
            } else {
                showLMSMessage('‚ùå ' + data.message, 'error');
            }
        } catch (e) {
            showLMSMessage('‚ùå Network error: ' + e.message, 'error');
        }
    }

    async function setPlayerVolume(playerId, volume) {
        try {
            const resp = await fetch('/api/lms/volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ player: playerId, volume: parseInt(volume) })
            });
            const data = await resp.json();
            
            // Update display
            const display = document.querySelector(`.volume-display[data-player-id="${playerId}"]`);
            if (display) {
                display.textContent = volume + '%';
            }
            
            if (data.status !== 'success') {
                showLMSMessage('‚ùå Volume control failed: ' + data.message, 'error');
            }
        } catch (e) {
            showLMSMessage('‚ùå Network error: ' + e.message, 'error');
        }
    }

    function showLMSMessage(message, type) {
        const msgEl = document.getElementById('lms-status-message');
        msgEl.textContent = message;
        msgEl.style.display = 'block';
        
        const colors = {
            success: { bg: 'rgba(46,204,113,0.2)', border: '#2ecc71', text: '#2ecc71' },
            error: { bg: 'rgba(231,76,60,0.2)', border: '#e74c3c', text: '#e74c3c' },
            warning: { bg: 'rgba(243,156,18,0.2)', border: '#f39c12', text: '#f39c12' }
        };
        
        const style = colors[type] || colors.success;
        msgEl.style.background = style.bg;
        msgEl.style.borderLeft = `4px solid ${style.border}`;
        msgEl.style.color = style.text;
        
        setTimeout(() => {
            msgEl.style.display = 'none';
        }, 5000);
    }

    // Initialize LMS on page load
    checkLMSStatus();
</script>
{% endblock %}
